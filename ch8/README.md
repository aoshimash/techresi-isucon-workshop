# Chapter8 押さえておきたい高速化手法

## 外部コマンド実行ではなく、ライブラリを利用する

アプリケーションからの外部コマンド呼び出しは、パフォーマンスとセキュリティの観点から避けた方がいい。

**パフォーマンス上の問題点**
- 起動したプロセスがメモリを消費するため、メモリの消費量が増える。

**セキュリティ上の問題点**
- OSコマンドインジェクション
  - シェルを経由することで脆弱性が紛れ込む余地が生じるので、シェルを経由しないGoの`exec.Command`とかを使えば解決できる。（でもパフォーマンス上の問題は残る）


## 開発用の設定で冗長なログを出力しない

アプリケーションもミドルウェアも両方やる。

前回大会ではミドルウェア(MySQL, Nginx)のことは気をつけていたけど、アプリケーションログは忘れていた（ような気がする）。

## HTTPクライアントの使い方

- 同一ホストへのコネクションを使い回す
- 適切なタイムアウトを設定する

### 同一ホストへのコネクションを使い回す

TCPはがコストがかかるのでTCPコネクションはなるべく使いまわした方がいい。

TLSはネットワークコストだけでなくCPU負荷も高い。しかし、ISUCONではNginxをTLS終端にしてしまうと思うので、内部通信でTLSは使わないから気にしなくていい。

Goの場合、標準パッケージの`http.Client`を使うとTCPコネクションとTLSセッションをいいかんじに使い回せるらしい。

### 適切なタイムアウトを設定する

Goの`http.Client`はデフォルトでタイムアウトが設定されていないので、レスポンスが遅いと無限に待ってしまう。そのせいでサーバーにリクエストが大量に溜まり、高負荷になってしまうこともあるので、タイムアウトの設定は必須。

タイムアウトの値はリクエストの特性によって分けることも有効。

- データの更新をしないGETは短め
- データの更新をするPOSTは長め

みたいなかんじ。

## 静的ファイル配信をリバースプロキシから直接配信する

基本は静的ファイルはnginxから直接配信するのがおすすめ。
色々あって全部の静的ファイルをnginxに配置できないときは、`try_files`を使ってnginxに静的ファイルがある場合はそれをそのまま返し、見つからない場合はアプリケーションサーバーにリクエストを送るみたいな設定もできる。

```conf
server {

 # 省略

 location /image/ {
   root /home/isucon/private_isu/webapp/public/;
   try_files $uri @app;
 }

 location @app {
   proxy_pass http://localhost:8080;
 }

}
```

この例だとまず`/home/isucon/private_isu/webapp/public/`にファイルがないか探しに行って、ない場合はアプリケーションにリクエストを送る設定になっている。


## HTTPヘッダーを活用してクライアント側にキャッシュさせる

更新頻度が低く、かつ何回も参照するファイル（画像・CSS・JavaScriptなど）は参照のたびにダウンロードするのは無駄なので、Cache-Controlヘッダーを使ってクライアントにキャッシュさせたい。

（クライアントがCache-Controlヘッダーの機能に対応してないとキャッシュできないから意味なくなってしまうのだが、private-isuのベンチマーカーは対応していないらしい。つまり本番でもベンチマーカーが対応してくれてなかったら意味ない？）

nginxなら次のように設定するとクライアントが1日キャッシュを保持することになる。

```conf
server {

  # 省略

  location /image/ {
    root /home/isucon/private_isu/webapp/public/;
    expires 1d;
  }

}
```


## CDN上にHTTPレスポンスをキャッシュする

ISUCONではCDN使わなさそうだからスキップ

## コラム: Goは速いのか？

#### Goの短所

- JSONを扱う標準ライブラリ(`encoding/json`)やHTMLのテンプレート(`html/template`)などは、PHPなどの他言語に性能で負けることもある。

- 正規表現を扱える標準パッケージ(`regexp`)はPerlやPHPなどの他言語とは異なるアルゴリズムを利用しており、性能特性が異なる。そして、Webアプリケーションでよく使われる正規表現はPerlやPHPの方が強いことが多い。
  - 正規表現ではなく文字列(`string`)で実装したほうが速いことが多いので、正規表現を使う前にまずはstringパッケージで書けないか検討するべき。

#### Go長所

- Goはシングルプロセス・マルチスレッドで動作する特徴から、インメモリキャッシュやgoroutineによる処理のバックグラウンド実行などが比較的容易に実装できる。
